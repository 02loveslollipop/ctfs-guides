# docker/Dockerfile
FROM ubuntu:24.04

ARG DEBIAN_FRONTEND=noninteractive
ARG GHIDRA_VERSION=11.2
ENV LANG=C.UTF-8 LC_ALL=C.UTF-8 \
    GHIDRA_HOME=/opt/ghidra \
    USER=ctf HOME=/home/ctf \
    PYTHONDONTWRITEBYTECODE=1 \
    PATH=/usr/local/bin:$PATH

# --- Base OS & core tools ---
RUN apt-get update && apt-get install -y --no-install-recommends \
    # essentials
    ca-certificates curl wget git unzip xz-utils build-essential cmake pkg-config \
    # python & java
    python3 python3-pip python3-venv openjdk-17-jre-headless \
    # binutils & RE/pwn basics
    file binutils patchelf checksec ropper upx-ucl \
    gdb gdbserver strace ltrace \
    # disassemblers
    radare2 rizin \
    # qemu (multi-arch user mode)
    qemu-user-static \
    # ruby for one_gadget
    ruby-full \
  && rm -rf /var/lib/apt/lists/*

# --- Ruby gem: one_gadget ---
RUN gem install one_gadget

# --- Python stack (pwntools, angr, etc.) ---
RUN python3 -m pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
      pwntools==4.* \
      angr==9.* \
      capstone unicorn keystone-engine r2pipe \
      z3-solver

# --- Ghidra headless ---
RUN mkdir -p /tmp/gh && \
    curl -L -o /tmp/gh/ghidra.zip \
      https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_${GHIDRA_VERSION}_PUBLIC/ghidra_${GHIDRA_VERSION}_PUBLIC_20240618.zip && \
    unzip -q /tmp/gh/ghidra.zip -d /opt && \
    mv /opt/ghidra_* ${GHIDRA_HOME} && \
    rm -rf /tmp/gh

# --- Non-root user & dirs ---
RUN useradd -m -s /bin/bash ${USER} && \
    mkdir -p /work /opt/tools && \
    chown -R ${USER}:${USER} /work /opt/tools ${GHIDRA_HOME}
USER ${USER}
WORKDIR /work

# --- (Optional) Pwndbg ---
COPY docker/pwndbg-setup.sh /tmp/pwndbg-setup.sh
RUN bash /tmp/pwndbg-setup.sh && rm /tmp/pwndbg-setup.sh || true

# --- Helper scripts ---
COPY tools /opt/tools
RUN chmod +x /opt/tools/*.sh

# --- Entrypoint ---
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
